{% extends "base.html" %}

{% block title %}Расписание{% endblock %}

{% block content %}
	<div style="text-align: center;">

        <h3>Расписание:</h3>
        <form action="/submit_preferences" method="POST">

            <div class="form-group">
                <label for="department">Факультет</label>
                <select class="form-control" id="department" name="department">
                    <option disabled selected value=""> Выберите факультет </option>
                    {% for url in departments.keys()%}
                    <option value="{{url}}">{{departments[url][0]}}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="course">Курс</label>
                <select class="form-control" id="course" name="course">
                    <option disabled selected value=""> Выберите курс </option>
                    {% for i in range (1, 6)%}
                    <option value="{{i}}">{{i}}</option>
                    {% endfor %}
                    <option value="other">Другое</option>
                </select>
            </div>

            <div class="form-group">
                <label for="group">Группа</label>
                <select class="form-control" id="group" name="group" disabled>
                    <option disabled selected value=""> Выберите группу </option>
                </select>
            </div>

            <input id="submit_preferences" name="submit_preferences" type="submit" class="submit_event" value="Выбрать">
        </form>
        <br>
       <h2><b>Текущий выбор:</b></h2>
        <h2><i>{{user_department}}, гр.{{user_group}}</i></h2>
        <br>
        {% for i in range(0, 6) %}
        <h2><b>{{week_days[i]}}:</b></h2>
                {% for row in data[i] %}
                    <div class="card" style="width: 80%; font-size: 20pt; border-radius: 20px; padding: 20px; background: rgba(255, 255, 255, 0.8);

                     margin: auto; ">

                         <a>
                             <b>Номер пары: {{row.lessonTime.lessonNumber}}</b>
                             <br><b>Время: {{"%02d" % row.lessonTime.hourStart}}:{{"%02d" % row.lessonTime.minuteStart}}-{{"%02d" % row.lessonTime.hourEnd}}:{{"%02d" % row.lessonTime.minuteEnd}}</b>
                             <br><b>Название: {{row.name}}</b>
                             <br>{{row.place}}
                             {% if not row.weekType == "FULL" %}
                             <br>{{week_types[row.weekType]}}
                             {% endif %}
                             <br>{{lesson_types[row.lessonType]}}
                             <br>Преподаватель: {{row.teacher.surname}} {{row.teacher.name}} {{row.teacher.patronymic}}
                        </a>

                    </div>
                    <br>
                {% endfor %}
        {% endfor %}
    </div>

<script>
var department =  document.getElementById('department');
var course = document.getElementById('course');
var group = document.getElementById('group');

var course_flag = false;
var department_flag = false;

department.onchange = handleChange_department;
course.onchange = handleChange_course;

function handleChange_department(e) {
    department_flag = true;
    handleChange_both();
}

function handleChange_course(e) {
    course_flag = true;
    handleChange_both();
}

function getGroups() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        html = "";
        var response = JSON.parse(this.responseText);
        for (var key in response["groupNumbers"]) {
            html += "<option value=\"" + response["groupNumbers"][key] + "\">" + response["groupNumbers"][key] + "</option>"
        }
      group.innerHTML = html;
    }
    };

    var link = "https://scribabot.ml/api/v1.0/group/number/" + department.value + "/do/" + course.value;
    xhttp.open("GET", link, true);
    xhttp.send();
}

function handleChange_both() {
    if (department_flag && course_flag) {
        group.disabled = false;
        getGroups();
    }
}
</script>

{% endblock %}